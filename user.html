<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SmartCart - User</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(-45deg, #2c3e50, #4e73a6, #6a5acd, #2c3e50);
      background-size: 400% 400%;
      animation: gradient-animation 15s ease infinite;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    @keyframes gradient-animation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .user-box {
      background: rgba(255,255,255,0.9);
      padding: 30px;
      border-radius: 16px;
      width: 90%;
      max-width: 900px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      animation: fade-in 1s ease;
      position: relative;
    }
    @keyframes fade-in { from{opacity:0;} to{opacity:1;} }

    #logoutBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #ff4d4d;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s, transform 0.1s;
    }
    #logoutBtn:hover { background: #e63946; transform: translateY(-1px); }

    h2 { color: #1e3c72; margin-bottom: 15px; }

    .cart {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px;
    }
    .card {
      background: white;
      padding: 12px;
      border-radius: 12px;
      width: 180px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      text-align: center;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.6s ease;
      position: relative;
    }
    .card.show { opacity: 1; transform: translateY(0); }
    .card img { width: 100%; height: 130px; object-fit: contain; margin-bottom: 8px; }
    .title { font-weight: 600; margin-bottom: 4px; }
    .price { color: #6a5acd; font-weight: bold; }
    .qty {
      position: absolute; top: 10px; right: 10px;
      background: #4e73a6; color: white;
      padding: 3px 8px; border-radius: 8px; font-size: 14px;
    }
    .checkout-btn {
      margin-top: 25px; padding: 10px 20px; font-size: 18px;
      background-color: #6a5acd; color: white;
      border: none; border-radius: 10px; cursor: pointer;
      transition: background 0.3s;
    }
    .checkout-btn:hover { background-color: #4e73a6; }
  </style>
</head>
<body>
  <div class="user-box">
    <button id="logoutBtn" onclick="logout()">Logout</button>
    <h2>ðŸ›’ SmartCart - Live View</h2>
    <div id="cart" class="cart"></div>
    <button class="checkout-btn" onclick="goToCheckout()">Checkout</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
  apiKey: "AIzaSyC1Y0HBSXo2bAiqZtQYbQwtNHv14co9K18",
  authDomain: "smartt-29ee2.firebaseapp.com",
  databaseURL: "https://smartt-29ee2-default-rtdb.firebaseio.com",
  projectId: "smartt-29ee2",
  storageBucket: "smartt-29ee2.firebasestorage.app",
  messagingSenderId: "56903620639",
  appId: "1:56903620639:web:dee055cac75260fa34dd2a",
  measurementId: "G-27RLVX6FXT"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const PRICE_LIST = {
      
      waterbottle:{ name:"Water Bottle",price:100,img:"images/waterbottle.png" },
      detergent:{ name:"Detergent",price:500,img:"images/detergent.png" },
      coke:{ name:"Coke Bottle",price:12,img:"images/coke.jpg" },
      sprite:{ name:"Sprite Bottle",price:12,img:"images/sprite.jpg" }
    };

    const cart = document.getElementById("cart");
    let cartItems = {};

    // Restore previous cart data
    const savedCart = localStorage.getItem("cartData");
    if(savedCart){
      cartItems = JSON.parse(savedCart);
      Object.values(cartItems).forEach(item => addCard(item.name, item.price, item.qty, item.key, false));
    }

    const ref = db.ref("arduino/current_item");
    const priceRef = db.ref("arduino/price_detected");

    // Detect same price -> redirect to choice.html
    priceRef.on("value", snap=>{
      const data = snap.val();
      if(data && data.price===12){
        console.log("âš–ï¸ Triggering choice.html...");
        localStorage.setItem("cartData", JSON.stringify(cartItems));
        window.location.href="choice.html";
      }
    });

    ref.on("value", snap=>{
      const d = snap.val();
      if(!d || !d.item){
        const cards = document.querySelectorAll(".card");
        if(cards.length>0){
          const lastKey = Object.keys(cartItems).pop();
          if(lastKey) delete cartItems[lastKey];
          cards[cards.length-1].classList.remove("show");
          setTimeout(()=>cards[cards.length-1].remove(),600);
        }
        localStorage.setItem("cartData", JSON.stringify(cartItems));
        return;
      }

      const name = (d.item||"").toLowerCase();
      let key=null;
      
     if(name.includes("bottle") && !name.includes("coke") && !name.includes("sprite")) key="waterbottle";
      else if(name.includes("detergent")) key="detergent";
      
      else if(name.includes("coke")) key="coke";
      else if(name.includes("sprite")) key="sprite";
      if(!key||!PRICE_LIST[key])return;

      const item=PRICE_LIST[key];
      if(cartItems[key]){
        cartItems[key].qty++;
        cartItems[key].element.querySelector(".qty").textContent="x"+cartItems[key].qty;
      }else{
        addCard(item.name,item.price,1,key);
      }
      localStorage.setItem("cartData", JSON.stringify(cartItems));
    });

    function addCard(name,price,qty,key,animate=true){
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <img src="${PRICE_LIST[key].img}" alt="${name}" />
        <div class="qty">x${qty}</div>
        <div class="title">${name}</div>
        <div class="price">â‚¹${price}</div>
      `;
      cart.appendChild(card);
      if(animate)setTimeout(()=>card.classList.add("show"),100);
      else card.classList.add("show");
      cartItems[key]={qty,element:card,price,name,key};
    }

    function goToCheckout(){
      localStorage.setItem("cartData", JSON.stringify(cartItems));
      window.location.href="health_analysis.html";
    }
    function logout(){
      localStorage.removeItem("cartData");
      window.location.href="index.html";
    }
  </script>
</body>
</html>
